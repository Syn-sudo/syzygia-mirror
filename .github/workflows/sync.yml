name: Sync Mirror

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Update repo databases
      run: |
        for repo in core extra; do
          if [ -d "packages/$repo" ] && [ -n "$(ls -A packages/$repo/*.pkg.tar.zst 2>/dev/null)" ]; then
            echo "Updating $repo database..."
            docker run --rm -v $PWD/packages/$repo:/repo \
              archlinux:latest bash -c "\
                pacman -Syu --noconfirm pacman-contrib && \
                repo-add -n /repo/$repo.db.tar.gz /repo/*.pkg.tar.zst"
          else
            echo "No packages found in $repo, skipping..."
          fi
        done
    
    - name: Commit changes
      run: |
        git config --global --add safe.directory /github/workspace
        git add packages/
        if ! git diff --staged --quiet; then
          git commit -m "Update repo databases"
          git push
        else
          echo "No changes to commit"
        fi
